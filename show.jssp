<!DOCTYPE html>
<?
    /*jssp code run on server*/
    var fs = require('fs');
    var filename = POST['filename'];
    var mdpath   = POST['filename'];
    var path  = __dirname + '/wiki/' + filename + '.md.html';
    var mddir = __dirname + '/wiki/' + mdpath + '.md.list';

    render('mdpath',mdpath);
    render('EditCreate','Edit');
    fs.stat(path,function(err,stats)
    {
      if(err)
      {
        var html = "<h1>This topic does not exist yet</h1>" +
            "<p>You've followed a link to a topic that doesn't exist yet." +
            "You may create it by clicking on “Create”.</p>"
        render('md_file_html',html);
        render('md_file_path',filename);
        render('EditCreate','Create');

        render('files',[]);
      }
      else
      {
        fs.readFile(path, function(err, data)
        {
          if(err)
          {
            echo('<h1>'+err+'</h1>');
            echo('<p>'+filename+'.md</p>');
            exit();
          }
          else
          {
            render('md_file_html',data.toString('utf8'));
            render('md_file_path',filename);
          }
        });

        fs.readdir(mddir,function(err,files)
        {
          if(err) files=[];

          var statlist = [];
          for(var i=0;i<files.length;i++)
          {
            var stat = fs.statSync(mddir+'/'+files[i]);
            stat.name = files[i];
            stat.time = stat.mtime.getTime();
            statlist.push(stat);
          }
          for(var i=0;i<statlist.length-1;i++)
            for(var j=i+1;j<statlist.length;j++)
            {
              if(statlist[i].time > statlist[j].time)
              {
                var s=statlist[i]; statlist[i]=statlist[j]; statlist[j]=s;
              }
            }

          files = [];
          for(var i=0;i<statlist.length;i++) files.push(statlist[i].name);
          render('files',files);
        }); //fs.readdir(mddir,function(err,files)
      }
    });
?>

<html>
  <head>
    <meta charset="utf-8">
    <link rel="stylesheet" href="/markdown-plus.min.css"/>
    <script type="text/javascript" src="/jquery-1.12.0.min.js"></script>
    <script type="text/javascript" src="/jqueryFileTree.js"></script>
    <link rel="stylesheet" href="/jqueryFileTree.css" />
    <style type="text/css">
      body {
        background: #f8f8f8;
        margin: 0px;
      }
      pre {
          white-space: pre-wrap;       /* css-3 */
          white-space: -moz-pre-wrap;  /* Mozilla, since 1999 */
          white-space: -pre-wrap;      /* Opera 4-6 */
          white-space: -o-pre-wrap;    /* Opera 7 */
          word-wrap: break-word;       /* Internet Explorer 5.5+ */
          background-color: #f8f8f8;
          border: 1px solid #dfdfdf;
          margin-top: 1.5em;
          margin-bottom: 1.5em;
          padding: 0.125rem 0.3125rem 0.0625rem;
      }

      .main .markdown-body pre code {
          background-color: transparent;
          border: 0;
          padding: 0;
          white-space: pre-wrap;
          word-wrap: break-word;
      }

      .headerbar {
        height: 45px;
      }

      .headermenu {
        float: right;
        margin: 20px 40px 10px 40px;
      }
      .main {
          position: absolute;
          width: 100%;
          min-height: 600px;
          top: 45px;
      }
      .contentarea {
          background: #fff;
          position: relative;
          width: 100%; 
          display: flex;
          float: left;
      }
      #sider {
          min-height: 500px;
          background: #fff;
          margin: 0px;
          flex:1 0 150px;
          padding: 10px;
          border-right: 1px solid #aaa;
      }
      #show {
          min-height: 500px;
          max-width: 100000px;
          flex:8 1 800px;
          background: #fff;
          margin: 10px;
          padding: 20px;
          overflow: auto;
      }
      .footarea {
          width: 100%;
          background: #fff;
      }

      .filelistmain {
          width: 100%;
          display: flex;
          float: left;
          background: #fff;
      }
      .filelistspace {
          flex:1 0 150px;
          padding: 10px;
          border-right: 1px solid #aaa;
          background: #fff;
      }
      .filelistreal {
          max-width: 100000px;
          flex:8 1 800px;
          margin: 10px;
          padding: 20px;
      }

      .singlefile {
          width: calc(50% - 30px);
          height: 21px;
          background: #ede;
          margin: 1px 0px 1px 10px;
          padding: 0px 0px 0px 15px;
          background-color: #f5f5f5;
          border: 1px solid #dcdcdc;
          float: left;
      }
      .singlefile a {
          color: #15c;
          font-weight: bold;
          font-size: 13px;
          font-family: arial,sans-serif;

          display: inline-block;
          overflow: hidden;
          padding: 3px 0;
          text-overflow: ellipsis;
          vertical-align: bottom;
          white-space: nowrap;
          max-width: 315px;
          text-decoration: none;
      }
    </style>
  </head>
  <body>
      <div class="headerbar">
        <div class="headermenu"><a href="/{{md_file_path}}?p=edit">{{EditCreate}}</a></div>
      </div>
      <div class="main">     

        <div class="contentarea">
            <div id="sider" class="sider"></div>
            <div id="show" class="show markdown-body">{{md_file_html}}</div>
            <textarea id="textdata" data-path="{{md_file_path}}" style="display: none;"></textarea>
        </div>
        <div class="footarea">
          <div class="filelistmain">
            <div class="filelistspace"></div>
            <div class="filelistreal">
              {{<div class="singlefile"><a href="/{{mdpath}}/{{files[i]}}" >{{files[i]}}</a><div></div></div>}}
            </div>
          </div>
        </div> 
      </div>

      <script type="text/javascript">
        var mdpath = $('#textdata').attr('data-path');
        var mdpathlong = '/' + mdpath;

        $(function () {
            $.getScript( "/mermaid.min.js");

            $('#sider').fileTree({
                root: '/',
                script: '/tree.jssp',
                expandSpeed: 100,
                collapseSpeed: 100,
                multiFolder: true
            },function(file) {
                // alert(file);
                window.location.href = ''+file;
            },function(dir,parent)
            {
              parent.find('.jqueryFileTree .directory a').each(function()
              {
                var rel = $(this).attr('rel');
                if(mdpathlong.indexOf(rel)>=0) $(this).triggerHandler('click','fastexpanded');
              });
            });
        });
      </script>
  </body>
</html>
